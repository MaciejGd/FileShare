<!DOCTYPE html >
<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body {
        background-color: #4ca6ef
;
        color : #2139d1;
        margin-left: 5%;
        margin-right: 5%;
        font-family: Arial, Helvetica, sans-serif;
      }
      #list {
        color: #2139d1;
        font-size: 1.2em;
        align-items: center;
        justify-content: space-between;
      }
      ul li {
        background: #cce5ff;
        color: darkblue;
        padding: 5px;
        display: flex;
      }
      a {
        flex-grow : 1;
        text-align: left;
      }
      #buttonID {
        color : darkblue;
        background-color: #4ca6ef;
        font-size: 0.8em; /* Adjust the size of the download symbol */
      }
    </style>
  </head>
  <body>
    <div>
      <h1 id="title">FILES TO DOWNLOAD</h1>
      <button id="prev" onclick="prev_node()">
        Previous_dir
      </button>
      <script>
        var previous_node = [];
        function fetchJSONData() {
          fetch("./.download.json").then((res) => {
            if (!res.ok)
              throw new Error (`HTTP error! Status: ${res.status}`);
            return res.json();
          })
          .then((data) => 
          {
            console.log(data.url)
            previous_node.push(data);
            populateList(data);
          })
          .catch((error) => 
            console.error("Unable to fetch data:", error));
        }
  
        function populateList(data) {
          var list = document.getElementById("list");
          list.innerHTML = "";

          data.files.forEach(file => {
              const listItem = document.createElement("li");
              const link = document.createElement("a");

              if (file.files && file.files.length !== 0) {              
                link.href = "#";
                link.textContent = file.name + " (Directory)";
                link.style.color = '#071a8f';
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    previous_node.push(data);
                    populateList(file);
                });
                const downloadAllButton = document.createElement("button");
                downloadAllButton.id = 'buttonID';
                downloadAllButton.textContent = "â¬‡";
                downloadAllButton.addEventListener('click', (event)=> {
                  event.stopPropagation();
                  //downloadAllFiles(file);
                  downloadAll(file.url);
                });
                listItem.appendChild(link);
                listItem.appendChild(downloadAllButton);
              } else {
                  link.href = file.url;
                  link.textContent = file.name;
                  link.setAttribute('download', '');
                  listItem.appendChild(link);
              }
              list.appendChild(listItem);
          });
        }
        function prev_node()
        {
          if (previous_node.length !== 0)
          {  
            console.log(previous_node);
            var last_node = previous_node.pop();
            populateList(last_node);
          }
        }
        function downloadAll(dir_url)
        {
          console.log('Dir url is: ', dir_url);
          fetch('/downloadAll', {
            method: 'POST',
            headers: {
              'Content-Type' : 'application/json'
            },
            body : JSON.stringify({
              directory: dir_url
            })
          })
          .then(response => {response.json()})
          .then(data => {
            const fileUrl = data.fileUrl;
            //poll server until file is ready
            checkFileAvailable(fileUrl);
          })
          .catch(error => console.error('Error initializing file creation: ', error));

        }
        //waiting for dir to compress
        function checkFileAvailable(fileUrl)
        {
          fetch(fileUrl, {
            method: 'HEAD'
          })
          .then(response => {
            if (response.ok)
              downloadFile(fileUrl + ".zip")
            else 
              setTimeout(() => checkFileAvailable(fileUrl), 2000);
          })
          .catch(error => console.error('Error in avialability check'));
        }

        function downloadFile(url)
        {
          const link = document.createElement('a');
          link.href = url;
          link.download = '';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }


        //the problem lays in here
        function downloadAllFiles(directory){
          const fileUrls = [];

          function collectFileUrls(file) {
            if (file.files && file.files.length !== 0)
            {
              file.files.forEach((subFile) => { collectFileUrls(subFile); }); 
            }
            else 
            {
              fileUrls.push(file.url);
            }
          }
          collectFileUrls(directory);

          fileUrls.forEach((url) => {
            console.log("downloaded url: " + url);
            const link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          })
        }
        fetchJSONData();
      </script>
	  <ul id="list">
	  </ul>
    
    </div>
  </body>
</html>
